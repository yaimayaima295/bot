// STEALTHNET 3.0 — PostgreSQL schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String   @map("password_hash")
  mustChangePassword Boolean @default(true) @map("must_change_password")
  role              String   @default("ADMIN")
  allowedSections   String?  @map("allowed_sections") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  refreshTokens     RefreshToken[]

  @@map("admins")
}

model RefreshToken {
  id        String   @id @default(cuid())
  adminId   String   @map("admin_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
  @@map("refresh_tokens")
}

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text

  @@map("system_settings")
}

// Клиент панели (покупатель подписок): сайт, бот, mini app
model Client {
  id               String    @id @default(cuid())
  email            String?   @unique
  passwordHash     String?   @map("password_hash")
  role             String    @default("CLIENT")
  remnawaveUuid    String?   @map("remnawave_uuid")
  referralCode     String?   @unique @map("referral_code")
  referrerId       String?   @map("referrer_id")
  balance          Float     @default(0)
  preferredLang    String    @default("ru") @map("preferred_lang")
  preferredCurrency String   @default("usd") @map("preferred_currency")
  telegramId       String?   @unique @map("telegram_id")
  telegramUsername String?   @map("telegram_username")
  isBlocked        Boolean   @default(false) @map("is_blocked")
  blockReason      String?   @map("block_reason")
  referralPercent  Float?   @map("referral_percent")
  trialUsed        Boolean   @default(false) @map("trial_used")
  yoomoneyAccessToken String? @map("yoomoney_access_token")
  utmSource        String?   @map("utm_source")
  utmMedium        String?   @map("utm_medium")
  utmCampaign      String?   @map("utm_campaign")
  utmContent       String?   @map("utm_content")
  utmTerm          String?   @map("utm_term")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  referrer   Client?   @relation("ClientReferrer", fields: [referrerId], references: [id])
  referrals  Client[]  @relation("ClientReferrer")
  payments   Payment[]
  referralCredits ReferralCredit[]
  promoActivations PromoActivation[]
  promoCodeUsages  PromoCodeUsage[]
  autoBroadcastLogs AutoBroadcastLog[]
  proxySlots ProxySlot[]

  @@index([telegramId])
  @@index([email])
  @@index([utmSource])
  @@map("clients")
}

// Ожидание подтверждения email при регистрации (ссылка из письма)
model PendingEmailRegistration {
  id               String   @id @default(cuid())
  email            String
  passwordHash     String   @map("password_hash")
  preferredLang    String   @default("ru") @map("preferred_lang")
  preferredCurrency String  @default("usd") @map("preferred_currency")
  referralCode     String?  @map("referral_code")
  utmSource        String?  @map("utm_source")
  utmMedium        String?  @map("utm_medium")
  utmCampaign      String?  @map("utm_campaign")
  utmContent       String?  @map("utm_content")
  utmTerm          String?  @map("utm_term")
  verificationToken String @unique @map("verification_token")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([verificationToken])
  @@index([email])
  @@map("pending_email_registrations")
}

model Payment {
  id           String   @id @default(cuid())
  clientId     String   @map("client_id")
  orderId      String   @unique @map("order_id")
  amount       Float
  currency     String
  status       String   @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  provider     String?  // yookassa, cryptobot, etc.
  externalId   String?  @map("external_id")
  tariffId     String?  @map("tariff_id")
  proxyTariffId String? @map("proxy_tariff_id")
  remnawaveUserId String? @map("remnawave_user_id")
  metadata     String?  @db.Text // JSON
  createdAt    DateTime @default(now()) @map("created_at")
  paidAt       DateTime? @map("paid_at")
  referralDistributedAt DateTime? @map("referral_distributed_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tariff Tariff? @relation(fields: [tariffId], references: [id], onDelete: SetNull)
  proxyTariff ProxyTariff? @relation(fields: [proxyTariffId], references: [id], onDelete: SetNull)
  referralCredits ReferralCredit[]

  @@index([clientId])
  @@index([status])
  @@index([tariffId])
  @@index([proxyTariffId])
  @@map("payments")
}

// Начисление реферального бонуса (для отчёта «заработок с рефералов»)
model ReferralCredit {
  id           String   @id @default(cuid())
  referrerId   String   @map("referrer_id")
  paymentId    String   @map("payment_id")
  amount       Float
  level        Int      // 1, 2 или 3
  createdAt    DateTime @default(now()) @map("created_at")

  referrer Client  @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  payment  Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([paymentId])
  @@map("referral_credits")
}

// ——— Промо-группы и активации ———
model PromoGroup {
  id               String   @id @default(cuid())
  name             String                            // Название промо-группы
  code             String   @unique                  // Уникальный код (используется в ссылке /start promo_<code>)
  squadUuid        String   @map("squad_uuid")       // UUID сквада в Remnawave
  trafficLimitBytes BigInt  @default(0) @map("traffic_limit_bytes")
  deviceLimit      Int?     @map("device_limit")
  durationDays     Int      @map("duration_days")    // На сколько дней даётся подписка
  maxActivations   Int      @map("max_activations")  // Макс. кол-во активаций (0 = без лимита)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  activations PromoActivation[]

  @@map("promo_groups")
}

model PromoActivation {
  id           String   @id @default(cuid())
  promoGroupId String   @map("promo_group_id")
  clientId     String   @map("client_id")
  createdAt    DateTime @default(now()) @map("created_at")

  promoGroup PromoGroup @relation(fields: [promoGroupId], references: [id], onDelete: Cascade)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([promoGroupId, clientId])
  @@index([promoGroupId])
  @@index([clientId])
  @@map("promo_activations")
}

// ——— Промокоды (скидки и бесплатные дни) ———
model PromoCode {
  id                String    @id @default(cuid())
  code              String    @unique                  // Уникальный промокод (вводится вручную)
  name              String                             // Описание / название
  type              String                             // DISCOUNT | FREE_DAYS
  // Для DISCOUNT:
  discountPercent   Float?    @map("discount_percent") // Скидка в %
  discountFixed     Float?    @map("discount_fixed")   // Или фикс. скидка в валюте
  // Для FREE_DAYS:
  squadUuid         String?   @map("squad_uuid")
  trafficLimitBytes BigInt?   @map("traffic_limit_bytes")
  deviceLimit       Int?      @map("device_limit")
  durationDays      Int?      @map("duration_days")
  // Общие:
  maxUses           Int       @default(0) @map("max_uses") // 0 = без лимита
  maxUsesPerClient  Int       @default(1) @map("max_uses_per_client")
  isActive          Boolean   @default(true) @map("is_active")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  usages PromoCodeUsage[]

  @@map("promo_codes")
}

model PromoCodeUsage {
  id          String   @id @default(cuid())
  promoCodeId String   @map("promo_code_id")
  clientId    String   @map("client_id")
  createdAt   DateTime @default(now()) @map("created_at")

  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([promoCodeId])
  @@index([clientId])
  @@map("promo_code_usages")
}

// Категория тарифов (например «Базовый», «Премиум»). emojiKey — код из админки (ordinary, premium) для подстановки эмодзи.
model TariffCategory {
  id        String   @id @default(cuid())
  name      String
  emojiKey  String?  @map("emoji_key") // ordinary | premium — подставляется эмодзи из настройки category_emojis
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tariffs Tariff[]

  @@map("tariff_categories")
}

// Тариф внутри категории: название, описание (опционально), срок, сквады, лимиты, цена
model Tariff {
  id                 String   @id @default(cuid())
  categoryId         String   @map("category_id")
  name               String
  description        String?  @db.Text
  durationDays       Int      @map("duration_days")
  internalSquadUuids String[] @map("internal_squad_uuids")
  trafficLimitBytes  BigInt?  @map("traffic_limit_bytes")
  deviceLimit        Int?     @map("device_limit")
  price              Float    @default(0)
  currency           String   @default("usd") @map("currency")
  sortOrder          Int      @default(0) @map("sort_order")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  category TariffCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([categoryId])
  @@map("tariffs")
}

// ——— Авто-рассылка (настраиваемые правила для удержания клиентов) ———
model AutoBroadcastRule {
  id           String   @id @default(cuid())
  name         String   @map("name")           // Название правила для админки
  triggerType  String   @map("trigger_type")    // after_registration | inactivity | no_payment | trial_not_connected | trial_used_never_paid | no_traffic | subscription_expired
  delayDays    Int      @map("delay_days")      // Дней после триггера (для after_registration / no_payment) или без платежа (inactivity)
  channel      String   @map("channel")         // telegram | email | both
  subject      String?  @map("subject")         // Тема письма (для email)
  message      String   @db.Text                // Текст (до 4096)
  enabled      Boolean  @default(true) @map("enabled")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  logs AutoBroadcastLog[]

  @@map("auto_broadcast_rules")
}

model AutoBroadcastLog {
  id        String   @id @default(cuid())
  ruleId    String   @map("rule_id")
  clientId  String   @map("client_id")
  sentAt    DateTime @default(now()) @map("sent_at")

  rule   AutoBroadcastRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  client Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([ruleId, clientId])
  @@index([ruleId])
  @@index([clientId])
  @@map("auto_broadcast_logs")
}

// ——— Прокси-ноды и продажа прокси ———
model ProxyNode {
  id                  String   @id @default(cuid())
  name                String   @default("")  // Название (админ или нода при регистрации)
  token               String   @unique       // Токен для регистрации и heartbeat
  status              String   @default("OFFLINE") // ONLINE | OFFLINE | DISABLED
  lastSeenAt          DateTime? @map("last_seen_at")
  publicHost          String?  @map("public_host") // IP или домен (из регистрации/heartbeat)
  socksPort           Int      @default(1080) @map("socks_port")
  httpPort            Int      @default(8080) @map("http_port")
  capacity            Int?     // Макс. слотов (опционально)
  currentConnections  Int      @default(0) @map("current_connections")
  trafficInBytes      BigInt   @default(0) @map("traffic_in_bytes")
  trafficOutBytes     BigInt   @default(0) @map("traffic_out_bytes")
  metadata            String?  @db.Text     // JSON от агента (CPU, RAM, версия)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  slots ProxySlot[]
  tariffAssignments ProxyTariffNode[]

  @@map("proxy_nodes")
}

model ProxyCategory {
  id        String   @id @default(cuid())
  name      String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tariffs ProxyTariff[]

  @@map("proxy_categories")
}

model ProxyTariff {
  id                 String   @id @default(cuid())
  categoryId         String   @map("category_id")
  name               String   // «1 прокси 30 дней»
  proxyCount         Int      @map("proxy_count")   // Кол-во прокси в пакете
  durationDays       Int      @map("duration_days")
  trafficLimitBytes  BigInt?  @map("traffic_limit_bytes") // На один слот (null = без лимита)
  connectionLimit    Int?     @map("connection_limit")     // На один слот
  price              Float    @default(0)
  currency           String   @default("usd")
  sortOrder          Int      @default(0) @map("sort_order")
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  category   ProxyCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  payments   Payment[]
  slots      ProxySlot[]
  assignedNodes ProxyTariffNode[]

  @@index([categoryId])
  @@map("proxy_tariffs")
}

model ProxyTariffNode {
  id       String @id @default(cuid())
  tariffId String @map("tariff_id")
  nodeId   String @map("node_id")

  tariff ProxyTariff @relation(fields: [tariffId], references: [id], onDelete: Cascade)
  node   ProxyNode   @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([tariffId, nodeId])
  @@index([tariffId])
  @@index([nodeId])
  @@map("proxy_tariff_nodes")
}

model ProxySlot {
  id                 String   @id @default(cuid())
  nodeId             String   @map("node_id")
  clientId           String   @map("client_id")
  proxyTariffId      String?  @map("proxy_tariff_id")
  login              String   // Уникален в рамках ноды
  password           String   // В открытом виде для выдачи и конфига на ноде
  expiresAt          DateTime @map("expires_at")
  trafficLimitBytes  BigInt?  @map("traffic_limit_bytes")
  connectionLimit    Int?     @map("connection_limit")
  trafficUsedBytes   BigInt   @default(0) @map("traffic_used_bytes")
  currentConnections Int     @default(0) @map("current_connections")
  status             String   @default("ACTIVE") // ACTIVE | EXPIRED | REVOKED
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  node        ProxyNode    @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  proxyTariff ProxyTariff? @relation(fields: [proxyTariffId], references: [id], onDelete: SetNull)

  @@unique([nodeId, login])
  @@index([nodeId])
  @@index([clientId])
  @@index([proxyTariffId])
  @@index([status])
  @@map("proxy_slots")
}
